package {{ .Package }}

import (
	"testing"

	"github.com/genjidb/genji"
	"github.com/genjidb/genji/testutil"
	"github.com/stretchr/testify/require"
)

func Test{{ .TestName }}(t *testing.T) {
	setup := func(t *testing.T, db *genji.DB) {
		t.Helper()

		q := `
{{- range .Suite.Setup }}
{{ . }}
{{- end }}
`
        err := db.Exec(q)
        require.NoError(t, err)
    }
    {{""}}
    {{- range .Suite.Tests }}
    // --------------------------------------------------------------------------
    t.Run("{{ .Name }}", func(t *testing.T) {
        db, err := genji.Open(":memory:")
        require.NoError(t, err)
        defer db.Close()

        setup(t, db)
        {{ "" }}

        {{- range .Statements }}
        t.Run(`{{ escapeBackticks (index .Expr 0) }}`, func(t *testing.T) {
            q := `
{{- range .Expr }}
{{ escapeBackticks . }}
{{- end }}
`
            {{- if .Fails }}
            err := db.Exec(q)
                {{- if .ErrorMatch }}
            testutil.RequireErrorMatch(t, "{{ .ErrorMatch }}", err)
                {{- else }}
            testutil.RequireFails(t, q, err)
                {{- end }}
            {{- else }}
            res, err := db.Query(q)
            require.NoError(t, err)
            defer res.Close()

            {{- if gt (len .Result) 0 }}
            raw := `
{{- range .Result }}
{{ escapeBackticks . }}
{{- end}}
`
            testutil.RequireStreamEq(t, raw, res)
            {{- end }}
            {{- end }}
        })
        {{ "" }}
        {{- end }}
    })
    {{""}}
    {{- end }}
}
